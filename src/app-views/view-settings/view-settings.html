<link rel="import" href="/bower_components/polymer/polymer-element.html">

<link rel="import" href="/src/app-main/app-methods.html">
<!-- state -->
<link rel="import" href="/src/app-state/state-media.html">
<link rel="import" href="/src/app-state/state-user-local.html">
<!---->
<!---->

<link rel="import" href="view-settings-list.html">
<link rel="import" href="view-settings-detail.html">

<dom-module id="view-settings">
  <template>
		<style>
			:host {
				--line-color: #DDDDDD;
			}
			.split {
				border-bottom: 1px var(--line-color) solid;
				
				display: grid; /* https://css-tricks.com/snippets/css/complete-guide-grid/ | http://grid.malven.co/ */
				grid-template-columns: 1fr 1fr;
			}
		</style>
		
		<!-- v.3 | css-grid layout, responsive, two columns -->

    <!--- ->
    <!-- state -->
    <state-media media-type="{{mediaType}}"></state-media>
    <state-user-local user-local="{{userLocal}}"></state-user-local>
    <app-methods id="methods" show-toast dispatch-event></app-methods>

		<div class="wrapper split">
      <view-settings-list selected="{{selected}}"
                          user-local="[[userLocal]]"
                          >
      </view-settings-list>
      <view-settings-detail selected="[[selected]]"></view-settings-detail>
    </div>
		
  </template>

  <script>
    class ViewSettings extends Polymer.Element {
      
			static get is() { return 'view-settings'; }
			
      static get properties() { return {
				
				mediaType: {
					type: String,
					notify: true,
				},
				
				_split: {
					type: Boolean,
					notify: true,
					computed: '_computeSplit(mediaType)',
				},

				selected: {
					type: String,
					notify: true,
				},
    
        userLocal: {
      		type: Object,
					notify: true,
          observer: '_userLocalChanged',
        },

				// settings: {
				// 	type: Object,
				// 	notify: true,
				// 	computed: '_computeSettings(settingsZip, settinsSwitch, settingsInput)',
				// },
				
				// settingsZip: {
				// 	type: Object,
				// 	notify: true,
				// 	//computed: '_computeSplit(mediaType)',
				// 	value: () => ({}),
				// },
				
				// settingsSwitch: {
				// 	type: Object,
				// 	notify: true,
				// 	value: () => ({}),
				// 	//computed: '_computeSplit(mediaType)',
				// },		
				
				// settingsInput: {
				// 	type: Object,
				// 	notify: true,
				// 	//computed: '_computeSplit(mediaType)',
				// 	value: () => ({}),
				// },
				
				// settingsInvite: {
				// 	type: Object,
				// 	notify: true,
				// 	//computed: '_computeSplit(mediaType)',
				// },
				
			}}
			
			constructor() {
				super();
			}

			ready() {
        super.ready();
        // //window.addEventListener('user-action-select', (e) => this.onUserActionSelect(e));
        // window.addEventListener( 'update-user-zip'    , e => this._onUpdateUserZip(e)    );
        // window.addEventListener( 'update-user-switch' , e => this._onUpdateUserSwitch(e) );
        // window.addEventListener( 'update-user-input'  , e => this._onUpdateUserInput(e)  );
        // //window.addEventListener( 'update-user-invite' , (e) => this._onUpdateUserInvite(e) ); // no need to save prior invitations to settings
        window.addEventListener( 'lead-type-selected'  , e => this._handleLeadTypeSelected(e)  );
        window.addEventListener( 'geo-select-valid'    , e => this._handleGeoSelectValid  (e)  );
		  }
			
			// connectedCallback() {
			// 	super.connectedCallback();
			// 	window.addEventListener('updateuserzip', (e) => this.onUpdateUserZip(e));
			// }

			// disconnectedCallback() {
			// 	super.disconnectedCallback();
			// 	window.removeEventListener('updateuserzip', (e) => this.onUpdateUserZip(e));
			// }
			
			// static get observers() {
			// 	return [
			// 		'_computeSettings(settingsZip.*, settinsSwitch.*, settingsInput.*)',
			// 	]
			// }
			
			_computeSplit(s) {
				return s !== 'mobile';
      }  
      
      _userLocalChanged(dataNew, dataOld) {
        // console.log('data-old\n', dataOld);
        // console.log('data-new\n', dataNew);

        const ready = dataNew;
        if(!ready) return;

        const userLocal = dataNew; //dataNew.value; // dataNew.base
        this.set('userLocal', userLocal);
        
        // console.log('user-local\n', userLocal);

        // this.set('leadType', userLocal['lead-type']);
        // console.log('lead-type\n', this.leadType);

        // const leadType = userLocal['lead-type'];
        // console.log('lead-type\n', leadType);
      }

      _handleLeadTypeSelected(e) { this._updateSettings('lead-type'  , e.detail); } // first arg must match datastore key, bc typeof data === 'string'
      _handleGeoSelectValid  (e) { this._updateSettings('geo-select' , e.detail); }

      _updateSettings(s, data) {
        // console.log(s, '\n', s);
        // console.log(data, '\n', data);

        let o = {};
        const dataType = typeof data;

        switch(dataType) {
          case 'string':
            o[s] = data;
            break;
          case 'object':
            o = data;
            break;
          default:
            console.error('Data provided does not match available types.');
            return;
        }

        const updatedData = Object.assign( this.userLocal, o );
        // console.log('updated-data\n', updatedData);
        // this._dispatchEvent('app-settings-changed', updatedData);
        this.save(updatedData);
      }

		  // _dispatchEvent(name, data) {
			// 	const n = name;
			// 	const o = {
			// 	  bubbles: true,
			// 		composed: true,
			// 		detail: data,
			// 	};
			// 	//console.log('o\n', o);
			// 	const d = new CustomEvent(n, o);
			// 	//console.log('d\n', d);
			// 	this.dispatchEvent(d);				
      // }

			save(data) {
				
				const timestamp = new Date().getTime();
				const methods = this.$.methods;
				
				// detail = {method: 'save'|'delete', entity: 'deal'|'bid'|'network', data: {new:'data'}}
				const method = 'save'; // 'save'|'delete'
				const entity = 'user-settings'; // 'zip'|'deal'|'bid'|'network'
				//const data = data;
				const timestampedData = { ...data, ...{timestamp: timestamp} };
				const detail = {
					method: method,
					entity: entity,
					// data: data,
					data: timestampedData,
				};
				
				methods.method(detail);
			}
			
			// _computeSettings(sZip, sSwitch, sInput) {
			// 	const out = {};
				
			// 	if(sZip    === undefined) { sZip    = {} }
			// 	if(sSwitch === undefined) { sSwitch = {} }
			// 	if(sInput  === undefined) { sInput  = {} }
				
			// 	out.zip = sZip;
			// 	out.switch = sSwitch;
			// 	out.input = sInput;
			// 	console.log('settings\n', out);
			// 	return out;
			// }
			
			// _onUpdateUserZip(e) {
			// 	console.log('on-update-user-zip\n', e);
			// 	const data = e.detail;
			// 	this.set('settingsZip', data);
			// 	console.log('settings-zip\n', this.settingsZip);
				
			// 	const settings = this.settings;
			// 	console.log('settings\n', settings);
			// 	this.save(settings);
			// }
			
			// _onUpdateUserSwitch(e) {
			// 	//console.log('on-update-user-switch\n', e); // {detail: {data: true, label: 'home'|'mortgage'|...}}
			// 	const data = e.detail;
			// 	if(!this.settingsSwitch) {
			// 		this.set('settingsSwitch', {});
			// 	}
			// 	this.set(['settingsSwitch', data.label], data.data);
			// 	console.log('settings-switch\n', this.settingsSwitch); // {data: true, label: 'home'|'mortgage'|...}
				
			// 	//const settings = this.settings;
			// 	const settings = this._computeSettings(this.settingsZip, this.settingsSwitch, this.settingsInput);
			// 	console.log('settings\n', settings);
			// 	this.save(settings);
			// }
			
			// _onUpdateUserInput(e) {
			// 	//console.log('on-update-user-input\n', e); // {detail: {data: 'somestring', label: 'text'|'email'}}
			// 	const data = e.detail;
			// 	if(!this.settingsInput) {
			// 		this.set('settingsInput', {});
			// 	}
			// 	this.set(['settingsInput', data.label1], data.data);
			// 	//console.log('settings-input\n', this.settingsInput); // {data: 'somestring', label: 'text'|'email'}
				
			// 	const settings = this.settings;
			// 	console.log('settings\n', settings);
			// 	this.save(settings);
			// }
			
			// _onUpdateUserInvite(e) { // no need to save prior invitations to settings
			// 	//console.log('on-update-user-invite\n', e); // {detail: {data: 'somestring', label: 'contact'}}
			// 	const data = e.detail;
			// 	this.set('settingsInvite', {});
			// 	this.set('settingsInvite[label]', data);
			// 	console.log('settings-invite\n', this.settingsInvite); // {data: 'somestring', label: 'contact'}
			// }
			
    }

    window.customElements.define(ViewSettings.is, ViewSettings);
  </script>

</dom-module>